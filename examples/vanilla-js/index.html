<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FHEVM SDK - Vanilla JavaScript Example</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .container {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #1a202c;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 2rem;
    }

    .section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
    }

    .section h2 {
      color: #2d3748;
      font-size: 1.125rem;
      margin-bottom: 1rem;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      color: #4a5568;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e0;
      border-radius: 0.375rem;
      font-size: 1rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      width: 100%;
      padding: 0.75rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 0.375rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #5a67d8;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .result {
      margin-top: 1rem;
      padding: 1rem;
      background: #edf2f7;
      border-radius: 0.375rem;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.875rem;
      word-break: break-all;
    }

    .success {
      color: #38a169;
      background: #f0fff4;
      border: 1px solid #9ae6b4;
    }

    .error {
      color: #e53e3e;
      background: #fff5f5;
      border: 1px solid #fc8181;
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .status.ready {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.loading {
      background: #feebc8;
      color: #7c2d12;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .footer {
      margin-top: 2rem;
      text-align: center;
      color: #a0aec0;
      font-size: 0.875rem;
    }

    .footer a {
      color: #667eea;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê FHEVM SDK</h1>
    <p class="subtitle">Vanilla JavaScript Example - No Framework Required</p>

    <!-- Status -->
    <div class="status loading" id="status">‚è≥ Loading...</div>

    <!-- Connect Section -->
    <div class="section">
      <h2>1. Connect Wallet</h2>
      <button onclick="connectWallet()" id="connectBtn">
        ü¶ä Connect MetaMask
      </button>
      <div class="result" id="walletResult" style="display: none;"></div>
    </div>

    <!-- Encrypt Section -->
    <div class="section">
      <h2>2. Encrypt Value</h2>
      
      <div class="input-group">
        <label for="encryptType">Type:</label>
        <select id="encryptType">
          <option value="euint32">euint32 (32-bit integer)</option>
          <option value="euint64">euint64 (64-bit integer)</option>
          <option value="ebool">ebool (boolean)</option>
        </select>
      </div>

      <div class="input-group">
        <label for="encryptValue">Value:</label>
        <input type="text" id="encryptValue" placeholder="Enter value (e.g., 42)">
      </div>

      <button onclick="encryptValue()" id="encryptBtn" disabled>
        üîí Encrypt
      </button>
      <div class="result" id="encryptResult" style="display: none;"></div>
    </div>

    <!-- Decrypt Section -->
    <div class="section">
      <h2>3. Decrypt Value</h2>
      
      <div class="input-group">
        <label for="decryptHandle">Ciphertext Handle:</label>
        <input type="text" id="decryptHandle" placeholder="0x...">
      </div>

      <button onclick="decryptValue()" id="decryptBtn" disabled>
        üîì Decrypt
      </button>
      <div class="result" id="decryptResult" style="display: none;"></div>
    </div>

    <div class="footer">
      <p>Built with ‚ù§Ô∏è for the <a href="https://www.zama.ai/" target="_blank">Zama</a> community</p>
      <p style="margin-top: 0.5rem;">
        <a href="https://docs.zama.ai/" target="_blank">Documentation</a> ‚Ä¢
        <a href="https://github.com/zama-ai/fhevm" target="_blank">GitHub</a>
      </p>
    </div>
  </div>

  <!-- Import SDK from CDN or local build -->
  <script type="module">
    import { createFhevmClient } from '../../packages/fhevm-sdk/dist/core/FhevmClient.js';
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6/+esm';

    // Global state
    let client = null;
    let wallet = null;
    let provider = null;
    const CONTRACT_ADDRESS = '0x0000000000000000000000000000000000000000'; // Replace with your contract

    // Update status
    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // Connect wallet
    window.connectWallet = async function() {
      const resultEl = document.getElementById('walletResult');
      const btnEl = document.getElementById('connectBtn');
      
      try {
        btnEl.disabled = true;
        updateStatus('Connecting...', 'loading');

        if (!window.ethereum) {
          throw new Error('MetaMask not found. Please install MetaMask!');
        }

        // Request accounts
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        // Create provider and wallet
        provider = new ethers.BrowserProvider(window.ethereum);
        wallet = await provider.getSigner();

        resultEl.style.display = 'block';
        resultEl.className = 'result success';
        resultEl.textContent = `‚úÖ Connected: ${accounts[0].slice(0, 10)}...${accounts[0].slice(-8)}`;

        // Initialize FHEVM client
        updateStatus('Initializing FHEVM...', 'loading');
        client = createFhevmClient({
          network: 'sepolia',
          provider: window.ethereum,
          autoInit: false,
        });

        await client.init();

        updateStatus('‚úÖ Ready to encrypt/decrypt', 'ready');
        
        // Enable buttons
        document.getElementById('encryptBtn').disabled = false;
        document.getElementById('decryptBtn').disabled = false;

      } catch (error) {
        resultEl.style.display = 'block';
        resultEl.className = 'result error';
        resultEl.textContent = `‚ùå Error: ${error.message}`;
        updateStatus('Connection failed', 'error');
      } finally {
        btnEl.disabled = false;
      }
    };

    // Encrypt value
    window.encryptValue = async function() {
      const resultEl = document.getElementById('encryptResult');
      const btnEl = document.getElementById('encryptBtn');
      const typeEl = document.getElementById('encryptType');
      const valueEl = document.getElementById('encryptValue');

      try {
        btnEl.disabled = true;
        updateStatus('Encrypting...', 'loading');

        const type = typeEl.value;
        let value = valueEl.value;

        // Parse value based on type
        if (type === 'ebool') {
          value = value.toLowerCase() === 'true';
        } else {
          value = BigInt(value);
        }

        // Encrypt
        const result = await client.encrypt(
          CONTRACT_ADDRESS,
          wallet.address,
          { type, value }
        );

        resultEl.style.display = 'block';
        resultEl.className = 'result success';
        resultEl.innerHTML = `
          ‚úÖ Encrypted successfully!<br>
          <strong>Handle:</strong> ${result.handles[0].slice(0, 20)}...<br>
          <strong>Proof size:</strong> ${result.inputProof.length} bytes
        `;

        updateStatus('‚úÖ Ready to encrypt/decrypt', 'ready');

      } catch (error) {
        resultEl.style.display = 'block';
        resultEl.className = 'result error';
        resultEl.textContent = `‚ùå Error: ${error.message}`;
        updateStatus('Encryption failed', 'error');
      } finally {
        btnEl.disabled = false;
      }
    };

    // Decrypt value
    window.decryptValue = async function() {
      const resultEl = document.getElementById('decryptResult');
      const btnEl = document.getElementById('decryptBtn');
      const handleEl = document.getElementById('decryptHandle');

      try {
        btnEl.disabled = true;
        updateStatus('Decrypting...', 'loading');

        const handle = handleEl.value;

        if (!handle || !handle.startsWith('0x')) {
          throw new Error('Invalid handle. Must start with 0x');
        }

        // Generate keypair
        const keypair = client.generateKeypair();

        // Create EIP-712
        const eip712 = client.createEIP712(
          keypair.publicKey,
          [CONTRACT_ADDRESS],
          Math.floor(Date.now() / 1000),
          365
        );

        // Sign
        const signature = await wallet.signTypedData(
          eip712.domain,
          { UserDecryptRequestVerification: eip712.types.UserDecryptRequestVerification },
          eip712.message
        );

        // Decrypt
        const decrypted = await client.decrypt(
          [{ handle, contractAddress: CONTRACT_ADDRESS }],
          {
            publicKey: keypair.publicKey,
            privateKey: keypair.privateKey,
            signature: signature.replace('0x', ''),
            startTimestamp: Math.floor(Date.now() / 1000),
            durationDays: 365,
            userAddress: wallet.address,
            contractAddresses: [CONTRACT_ADDRESS],
          }
        );

        resultEl.style.display = 'block';
        resultEl.className = 'result success';
        resultEl.innerHTML = `
          ‚úÖ Decrypted successfully!<br>
          <strong>Value:</strong> ${String(decrypted[handle])}
        `;

        updateStatus('‚úÖ Ready to encrypt/decrypt', 'ready');

      } catch (error) {
        resultEl.style.display = 'block';
        resultEl.className = 'result error';
        resultEl.textContent = `‚ùå Error: ${error.message}`;
        updateStatus('Decryption failed', 'error');
      } finally {
        btnEl.disabled = false;
      }
    };

    // Initialize on load
    window.addEventListener('load', () => {
      updateStatus('üëÜ Connect wallet to get started', 'loading');
    });
  </script>
</body>
</html>

